<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CMNK Staking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: linear-gradient(135deg, #0a2540, #0b3d91); color: #fff; }
    .container { max-width: 420px; margin: 60px auto; padding: 24px; background: rgba(255,255,255,0.06); border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    h1 { text-align: center; margin-bottom: 8px; }
    .subtitle { text-align: center; font-size: 14px; color: #bcd7ff; margin-bottom: 24px; }
    .stat { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
    input, button {
      width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; border: none; border-radius: 10px;
    }
    button { font-weight: bold; cursor: pointer; }
    button.primary { background: #00ccff; color: #002b5c; }
    button.secondary { background: #ffffff; color: #002b5c; }
    button.danger { background: #ff5c5c; color: #ffffff; }
    .footer { text-align: center; font-size: 12px; margin-top: 20px; color: #bcd7ff; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h1>CMNK Staking</h1>
    <div class="subtitle">Stake CMNK • 5% APR • No lock time • BNB Chain</div>
    <div class="stat"><span>Your Staked</span><strong id="stakedAmount">-</strong></div>
    <div class="stat"><span>Pending Rewards</span><strong id="pendingRewards">-</strong></div>
    <button id="connectWallet" class="primary">Connect Wallet</button>
    <input id="stakeInput" type="number" placeholder="Amount to stake" disabled />
    <button id="stakeBtn" class="primary" disabled>Stake</button>
    <button id="claimBtn" class="secondary" disabled>Claim Rewards</button>
    <button id="unstakeBtn" class="danger" disabled>Unstake</button>
    <div class="footer">Staking contract: 0x07d62b6725f559e4ca7dfc04586c0cf294f58aa9</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <script>
    const stakingAddress = '0x07d62b6725f559e4ca7dfc04586c0cf294f58aa9';
    const tokenAddress   = '0xd17c85824eB60d40D332e64B0167E0B4029F49BA';

    const stakingAbi = [
      {
        "inputs":[{"internalType":"address","name":"_token","type":"address"}],
        "stateMutability":"nonpayable",
        "type":"constructor"
      },
      {
        "anonymous":false,
        "inputs":[
          {"indexed":true,"internalType":"address","name":"user","type":"address"},
          {"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}
        ],
        "name":"Staked",
        "type":"event"
      },
      {
        "anonymous":false,
        "inputs":[
          {"indexed":true,"internalType":"address","name":"user","type":"address"},
          {"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}
        ],
        "name":"Unstaked",
        "type":"event"
      },
      {
        "anonymous":false,
        "inputs":[
          {"indexed":true,"internalType":"address","name":"user","type":"address"},
          {"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}
        ],
        "name":"Claimed",
        "type":"event"
      },
      {
        "inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],
        "name":"stake",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
      },
      {
        "inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],
        "name":"unstake",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
      },
      {
        "inputs":[],
        "name":"claim",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
      },
      {
        "inputs":[{"internalType":"address","name":"user","type":"address"}],
        "name":"pendingRewards",
        "outputs":[{"internalType":"uint256","name":"","type":"uint256"}],
        "stateMutability":"view",
        "type":"function"
      },
      {
        "inputs":[{"internalType":"address","name":"","type":"address"}],
        "name":"stakes",
        "outputs":[
          {"internalType":"uint256","name":"amount","type":"uint256"},
          {"internalType":"uint256","name":"rewardDebt","type":"uint256"},
          {"internalType":"uint256","name":"lastUpdate","type":"uint256"}
        ],
        "stateMutability":"view",
        "type":"function"
      }
    ];

    const erc20Abi = [
      { constant:true, inputs:[{ name:"", type:"address"}], name:"balanceOf", outputs:[{ name:"", type:"uint256"}], type:"function" },
      { constant:false, inputs:[{ name:"spender", type:"address"}, { name:"amount", type:"uint256"}], name:"approve", outputs:[{ name:"", type:"bool"}], type:"function" }
    ];

    let web3, stakingContract, tokenContract, userAccount;

    async function connect() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const accounts = await web3.eth.getAccounts();
          userAccount = accounts[0];
          stakingContract = new web3.eth.Contract(stakingAbi, stakingAddress);
          tokenContract   = new web3.eth.Contract(erc20Abi, tokenAddress);
          document.getElementById('connectWallet').innerText = 'Wallet Connected';
          document.getElementById('stakeInput').disabled = false;
          document.getElementById('stakeBtn').disabled = false;
          document.getElementById('claimBtn').disabled = false;
          document.getElementById('unstakeBtn').disabled = false;
          await refreshStats();
        } catch (err) {
          alert('Could not connect wallet: ' + err.message);
        }
      } else {
        alert('Please install MetaMask or another Web3 wallet');
      }
    }

    async function refreshStats() {
      // Pobierz stakowane tokeny i nagrody — jeśli funkcje kontraktu zwracają dane
      try {
        const stakeInfo = await stakingContract.methods.stakes(userAccount).call();
        const pending = await stakingContract.methods.pendingRewards(userAccount).call();
        // Konwertuj z wei na ludzką liczbę (załóżmy 18 dec)
        const staked = web3.utils.fromWei(stakeInfo.amount, 'ether');
        const rewards = web3.utils.fromWei(pending, 'ether');
        document.getElementById('stakedAmount').innerText = staked;
        document.getElementById('pendingRewards').innerText = rewards;
      } catch(e) {
        console.log('Error reading contract data', e);
      }
    }

    document.getElementById('connectWallet').onclick = connect;
    document.getElementById('stakeBtn').onclick = async () => {
      const amt = document.getElementById('stakeInput').value;
      if (!amt || amt <= 0) { alert('Enter amount'); return; }
      const amount = web3.utils.toWei(amt, 'ether'); 
      await tokenContract.methods.approve(stakingAddress, amount).send({ from: userAccount });
      await stakingContract.methods.stake(amount).send({ from: userAccount });
      await refreshStats();
    };
    document.getElementById('claimBtn').onclick = async () => {
      await stakingContract.methods.claim().send({ from: userAccount });
      await refreshStats();
    };
    document.getElementById('unstakeBtn').onclick = async () => {
      const amt = document.getElementById('stakeInput').value;
      if (!amt || amt <= 0) { alert('Enter amount'); return; }
      const amount = web3.utils.toWei(amt, 'ether');
      await stakingContract.methods.unstake(amount).send({ from: userAccount });
      await refreshStats();
    };
  </script>
</body>
</html>
